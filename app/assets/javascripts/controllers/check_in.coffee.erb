'use strict'

Application.Controllers.controller "CheckInController",["$rootScope", "$scope", "$window", '$locale', "Session", "Auth", "$uibModal", "$state", 'growl', 'Notification', '$interval', "Setting", '_t','CSRF'
, ($rootScope, $scope, $window, $locale, Session, Auth, $uibModal, $state, growl, Notification, $interval, Setting, _t,CSRF) ->
  
  actualizarHora = ->
    fecha = new Date
    hora = fecha.getHours()
    minutos = fecha.getMinutes()
    segundos = fecha.getSeconds()
    diaSemana = fecha.getDay()
    dia = fecha.getDate()
    mes = fecha.getMonth()
    anio = fecha.getFullYear()
    ampm = undefined
    $pHoras = $('#horas')
    $pSegundos = $('#segundos')
    $pMinutos = $('#minutos')
    $pAMPM = $('#ampm')
    $pDiaSemana = $('#diaSemana')
    $pDia = $('#dia')
    $pMes = $('#mes')
    $pAnio = $('#anio')
    semana = [
      'Domingo'
      'Lunes'
      'Martes'
      'Miercoles'
      'Jueves'
      'Viernes'
      'Sabado'
    ]
    meses = [
      'Enero'
      'Febrero'
      'Marzo'
      'Abril'
      'Mayo'
      'Junio'
      'Julio'
      'Agosto'
      'Septiembre'
      'Octubre'
      'Noviembre'
      'Diciembre'
    ]
    $pDiaSemana.text semana[diaSemana]
    $pDia.text dia
    $pMes.text meses[mes]
    $pAnio.text anio
    if hora >= 12
      hora = hora - 12
      ampm = 'PM'
    else
      ampm = 'AM'
    if hora == 0
      hora = 12
    if hora < 10
      $pHoras.text '0' + hora
    else
      $pHoras.text hora
    if minutos < 10
      $pMinutos.text '0' + minutos
    else
      $pMinutos.text minutos
    if segundos < 10
      $pSegundos.text '0' + segundos
    else
      $pSegundos.text segundos
    $pAMPM.text ampm
  $scope.login = () -> 
    user=$scope.user
    Auth.login(user).then (user) ->
    # Authentification succeeded ...
        url= 'check_ins/'+user.id+'/is_checked'
        $.get url, (response)->
          $scope.is_checked = response.message
          is_auth = $scope.is_auth = true
          $scope.lastcheck=response.lastCheck
          $scope.lastcheck.check_in = new Date($scope.lastcheck.check_in).toLocaleString()
          if $scope.lastcheck.check_out
             $scope.lastcheck.check_out = new Date($scope.lastcheck.check_out).toLocaleString()
        Auth.logout(user)
        $scope.id = user.id
    , (error) ->
        # Authentication failed...
        console.log error
        console.log 'failed'
        $scope.alerts = []
        $scope.alerts.push
        msg: _t('wrong_email_or_password')
        type: 'danger'
        
  
  $scope.check = () -> 
      CSRF.setMetaTags()
      url= 'check_ins/'+$scope.id+'/check'
      $.post url, (response)->
        initialize()
  $scope.cancel =()->
    initialize()
  initialize = ->
   Auth.logout(user)
   user = $scope.user = {}
   is_auth = $scope.is_auth = false
   is_checked = $scope.is_checked = false
  intervalo = setInterval(actualizarHora, 1000)
  actualizarHora()
  initialize()
 
]
